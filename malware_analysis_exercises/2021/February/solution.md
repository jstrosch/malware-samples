# Maldocs Analysis Exercise - Getting Started with Excel 4 Macros (XLM Macros)

## Challenge Solutions

### Sample 1 - MD5: fb5ed444ddc37d748639f624397cff2a  

1. [This document is encrypted, what is the password to decrypt it?](#finding-the-password)

2. [What command argument would you use with OLEDUMP's *plugin_biff* to select all records relevant for Excel 4.0 macros?](#using-plugin_biff)

3. [What URL is the malware using to download the next stage?](#extracting-iocs)

4. [What malware family was this document attempting to drop?](#what-is-the-malware)

### Sample 2 - MD5: b5d469a07709b5ca6fee934b1e5e8e38  

1. [This document has a very hidden sheet, what was it named?](#very-hidden-sheets)

2. [This document uses *reg.exe*, what is the purpose?](#what-is-reg.exe-for)

3. [This document goes on to perform a number of additional anti-analysis checks, what Excel 4 macro function does it use?](#more-anti-analysis)

4. [What type of payload is downloaded? How is it executed?](#where-is-the-payload)

5. [What was the payload?](#the-malware)

## Finding the Password

Begin by investigating this file for the presence of macros – using OLEDUMP we can see that there are none…

<img alt="Oledump output" src="https://user-images.githubusercontent.com/1920756/106375993-a0244180-6356-11eb-9fd7-59d117914800.png" width="800">

Is this a malicious document? Three months after it was first submitted to VirusTotal it still has relatively low detection (first submission – 2020/04/01, time of screenshot – 2020/07/22):

<img alt="VirusTotal" src="https://user-images.githubusercontent.com/1920756/106376014-c944d200-6356-11eb-9380-7a4b6e37fa64.png" width="800">

It is possible for the content of the XLS file to be encrypted, we’ll use msoffcrypto-tool to check:

<img alt="msoffcrypto-tool" src="https://user-images.githubusercontent.com/1920756/106376023-e24d8300-6356-11eb-8775-710d7b713615.png" width="800">

It is! So we need to know the password to decrypt this file before we can examine the macros, but what is it? Some malware campaigns will send the password in the email, helping to avoid analysis from security researchers (if they don’t get the original email) and arguable adding some additional legitimacy to the social engineering. However, that was not the case here – instead it uses a known technique to automatically decrypt the file – this is accomplished through the use of the “VelvetSweatshop” password. Using this as the password, Office will automatically decrypt the XLS document and execute the macros. Oddly enough, this was discovered years ago and is still an issue to this day… 

Using MSOFFCRYPTO-TOOL, we can provide the password and decrypt the document:

<img alt="decrypting doc" src="https://user-images.githubusercontent.com/1920756/106376049-0e690400-6357-11eb-9ba5-bba2c2ae06b4.png" width="800">

And now we can investigate using OLEDUMP:

<img alt="decrypted doc" src="https://user-images.githubusercontent.com/1920756/106376055-1fb21080-6357-11eb-8861-8ca2ee6eeae7.png" width="800">

Hm, still no macros? It’s possible that this document could be using Excel 4 macros, let’s check with the plugin_biff plugin for OLEDUMP...

## Using PLUGIN_BIFF

OLEDUMP provides a number of plugins and, in particular, the plugin_biff for inspecting the binary file format of Excel 97 - 2003 documents. BIFF stands for Binary Interchange File Format and this structure varies from the current VBA format used currently by office documents. This means that we'll need to use this plugin to identify potential Excel 4 macro use.

<img alt="plugin biff" src="https://user-images.githubusercontent.com/1920756/106376161-21300880-6358-11eb-8994-b64dd661e370.png" width="800">

Sure enough, the plugin has found Excel 4 macros. These have become quite popular in 2020, if you open the document using the Office IDE you’ll see the macro content spread throughout the cells and workbooks in the document. This makes it incredibly difficult to trace these macros, especially when they are obfuscated as they jump execution around cells within the workbook (and usually over multiple sheets).

<img src="https://user-images.githubusercontent.com/1920756/106376247-0f029a00-6359-11eb-887c-a80e49b32d61.png" alt="cell" width="800">

But this can be a lot of information - can we get a summary? You can use *--pluginoptions "-h"* to get arguments for plugins.

<img alt="options" src="https://user-images.githubusercontent.com/1920756/106376196-7c61fb00-6358-11eb-89a9-f5febaf31f7e.png" width="800">

So *-x* will select all recrods relevant Excel 4 macro:

<img alt="summary" src="https://user-images.githubusercontent.com/1920756/106376233-e4b0dc80-6358-11eb-99a1-22f14c93fa18.png" width="800">

In addition, the sheets in the workbook can be hidden and very hidden, making them a little harder to find initially. The plugin_biff will tell you if there are hidden sheets, there are YARA sigs to help identify them as well and you can also detect and reveal hidden sheets in Office. If you need to reveal very hidden sheets, check out this blog post by [Didier Stevens](https://isc.sans.edu/diary/Excel+Maldocs%3A+Hidden+Sheets/25876).

<img src="https://user-images.githubusercontent.com/1920756/106376282-66086f00-6359-11eb-82d4-ce33b45033ee.png" alt="Office" width="800">

## Extracting IOCs

In some cases, documents will use minimal or no obfuscation and you can extract key IOCs by grepping content from plugin_biff output. For example, let’s look for HTTP URLs that the next stage payload may come from:

<img src="https://user-images.githubusercontent.com/1920756/106376297-93edb380-6359-11eb-96ea-ec114c3b9c5a.png" width="800">

However, it won’t always be this easy. Malware authors have gone to much greater lengths to obfuscate key IOCs and even add in extensive anti-analysis. While you can (and may have to at times) trace code from the plugin_biff output or directly in the document in Office, the XLMDeobfuscator by DissectMalware eases the analysis burden here.

## XLMDeobfuscator

The XLMDeobfuscator is already installed in your REMNux VM. From a terminal, you can run this tool providing either the decrypted file (output from msoffcrypto-tool) or the encrypted file and add the “-p” argument with the password “VelvetSweatshop”.

<img src="https://user-images.githubusercontent.com/1920756/106376311-bda6da80-6359-11eb-8b26-0f97b1af7059.png" width="800">

As you can see from this output, it helps to quickly analyze the macro code and provide results – we can see that this document will create a directly, download a payload from our previously discovered domain and execute it using ShellExecuteA:

<img src="https://user-images.githubusercontent.com/1920756/106376324-db743f80-6359-11eb-95bd-4a272eca2557.png" width="800">

## What is the malware

One of my first stops to check is always the URLHaus at [Abuse.ch](https://urlhaus.abuse.ch). Your IOCs may not always be there right away, but give it some time and it will likely show up. You can also considering contributing back to the community and submitting those IOCs yourself!

[URL on abuse.ch](https://urlhaus.abuse.ch/browse.php?search=http%3A%2F%2Frilaer.com%2FIfAmGZIJjbwzvKNTxSPM%2Fixcxmzcvqi.exe)

<img src="https://user-images.githubusercontent.com/1920756/106376372-65bca380-635a-11eb-8e2c-420c8cb39fb4.png" alt="urlhaus" width="800">

# Sample 2

## Very Hidden Sheets

The name of the very hidden sheet is *CSHykdYHvi*, we can use plugin_biff to help identify the presense of these very hidden sheets as well as some of the internal structure.

<img src="https://user-images.githubusercontent.com/1920756/106376421-d06ddf00-635a-11eb-83c3-3c3871e7e952.png" width="800">

While there are many ways to unhide very hidden sheets, since we're already using OLEDUMP let's explore that. By providing the plugin options of *-o BOUNDSHEET -a* we can get search for BOUNDSHEETs only, and display the results in a hex-dump. This allows us to see the enough of the byte values to edit directly in a hex editor - unhidden sheets have a value of 0x00, hidden 0x01 and very hidden 0x02. In the following screenshot, you can see our sheet with a name of *CSHykdYHvi* and a hex sequence of *3A D9 01 00 02*, where 02 indicates the very hidden sheet.

<img src="https://user-images.githubusercontent.com/1920756/106376524-c39dbb00-635b-11eb-9bae-966e8fac548a.png" width="800">

And if you edit directly in a hex-editor, you will be able to see the sheet in Office if/when necessary.

<img src="https://user-images.githubusercontent.com/1920756/106376548-fa73d100-635b-11eb-9e59-4e2c46f946bf.png" width="800">
<br>
<img src="https://user-images.githubusercontent.com/1920756/106376558-1f684400-635c-11eb-85e3-d742b6f57565.png">

## What is REG.EXE for

If you inspect the Excel 4 macros with the XLMDeobfuscator, you'll see deobfuscated code and, in particular, how it's using *reg.exe*.

<img src="https://user-images.githubusercontent.com/1920756/106376650-f98f6f00-635c-11eb-9004-e1429025e70c.png" width="800">

The macros use reg.exe to write value of HKCU\Microsoft\Office\<VERSION_NUM>\Excel\Security to temp file, then checks for VBAWarnings reg key value of 0001 - which is enable all macros. If true, quits otherwise goes on to additional anti-analysis checks.

## More Anti-Analysis

So why would we want to dig this deep into this document? Well, anti-analysis if often used to detect a sandbox, or other analysis environment, and change it's behavior. This document is not exception, in a sandbox it appears to exhibit minimal malicious behaviors - so we have to dig in and see what it's detecting. For this document, there is no additional process behavior (outside of reg.exe) and no network activity - let's see what's going on.

<img src="https://user-images.githubusercontent.com/1920756/106376745-b7b2f880-635d-11eb-9c8f-530c700bccbc.png" width="800">

The anti-analysis checks begin with a series of conditional statements that use the GET.WORKSPACE function to return information about the environment. 

<img src="https://user-images.githubusercontent.com/1920756/106376816-3019b980-635e-11eb-93ef-766f21d023be.png" width="800">

Most of these checks rely on the function *GET.WORKSPACE*, and I've documented them here in the hopes that they'll be easier to find for researchers - [GET.WORKSPACE reference and additional information](https://0xevilc0de.com/excel-4-macros-get-workspace-reference/)

Here are some ways in which they are used:

<pre>GET.WORKSPACE(13) < 770: usable workspace width
GET.WORKSAPCE(14) < 381: usable workspace height
</pre>
If the dimensions of the workspace it too small, assume a sandbox.

<pre>
GET.WORKSPACE(19): Returns true if a mouse is present, false if not.
</pre>
If no mouse is present, assumes a sandbox.
<pre>
GET.WORKSPACE(42): T/F if computer is capable of playing sound
</pre>
No sound = sandbox
<pre>
IF(ISNUMBER(SEARCH(""Windows"",GET.WORKSPACE(1))): name of environment in which Excel is running
</pre>
If not Windows, quits.

## Where is the Payload

As is often the case, there is a constant back-and-forth between malware authors and tool writers in which the malware authors will come up with ways to reduce tool effectiveness. As great as XLMDeobfuscator is, malware authors can find ways to, usually temporary, disrupt it's ability to evaluate macros. This document is one such example and gives us an opportunity to explore the document in a little more detail. This will give us the ability to get a better understanding of just how much XLMDeobfsucator can help us and how these Excel 4 documents take shape.

Error at the time I created this lab:

<img src="https://user-images.githubusercontent.com/1920756/106376939-09a84e00-635f-11eb-9c8d-9d5eeee4e7b0.png" width="800">

If you inspect the very hidden sheet (see above if you need to unhide it), the pattern that it uses becomes almost immediately apparent.

<img src="https://user-images.githubusercontent.com/1920756/106376961-32304800-635f-11eb-824c-72fda92e7ae2.png" width="800">

The first columns contain CHAR values that are interpreted by formulas in the J columns. While this is a fairly simple pattern, it was effective in slowing down our analysis, avoiding simple tools such as strings, and will be a bit tedious to manually defeat. However, sometimes tackling these problems in the only solution we have at hand.

While there are several ways to unravel this, one simple way is to copy the columns into a text-editor, remove all of the characters that are not a part of the char code (so everythign that is not a numerical value) and then convert using CyberChef. Note that a few of the cell values contain two instances of the CHAR code value.

<img src="https://user-images.githubusercontent.com/1920756/106377061-f6e24900-635f-11eb-9c5b-51d0fb5f3d8d.png" width="800">

Recipe on [CyberChef](https://gchq.github.io/CyberChef/#recipe=From_Charcode('Line%20feed',10)&input=NjEKNjcKNzAKNjUKNzYKNzYKNDAKMzQKMTE3CjExNAo3MQoxMDgKMTA5CjExMQoxMTAKMzQKNDQKMzQKODUKODIKNzYKNjgKMTAyCjExMQoxMTkKMTEwCjEwOAoxMTEKOTcKMTAwCjEwMgo4NAoxMTEKNzAKMTA1CjEwOAoxMDEKNjUKMzQKNDQKMzQKNzQKNzQKNjcKNjcKNzQKNzQKMzQKNDQKNDgKNDQKMzQKMTA0CjExNgo4NQoxMTYKMTEyCjExNQo2OQo1OAo0Nwo0NwoxMDEKMTE2CjEwNAoxMDEKMTA4CjY1CjEwMQoxMTAKMTAxCjk5CjExNAo5Nwo5OQoxMDEKNDYKMTIwCjEyMQoxMjIKNDcKMTAyCjk4Cjk4CjUxCjM0CjQ0CjM0Cjk5CjU4CjkyCjg1CjExNQoxMDEKMTE0CjExNQo5Mgo4MAoxMTcKOTgKMTA4CjEwNQo5OQo5Mgo5OAoxMDkKMTA2CjExMAo1MwoxMDEKMTAyCjQ2CjEwNAoxMTYKMTA5CjEwOAozNAo0NAo0OAo0NAo0OAo0MQ)

So our payload is coming from *hxxps://ethelenecrace[.]xyz/fbb3* and will be written as an HTML file.

You may notice that some of the content appears to have stray characters in it - that's because the original FORMULA in the document skip some of the cells, which I didn't do here:

<img src="https://user-images.githubusercontent.com/1920756/106377107-31e47c80-6360-11eb-96b7-01a705e9e257.png">

## The Malware

For this answer we'll turn to Twitter and discover its Zloader

<img src="https://user-images.githubusercontent.com/1920756/106377155-999ac780-6360-11eb-904d-6620362026af.png" width="800">
